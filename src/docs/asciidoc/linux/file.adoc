[[file]]
= 文件系统管理

在 Linux 系统中，文件系统是创建在硬盘上的，因此，要想彻底搞清楚文件系统的管理机制，就要从了解硬盘开始。

硬盘是计算机的主要外部存储设备。计算机中的存储设备种类非常多，常见的主要有光盘、硬盘、U 盘等，甚至还有网络存储设备 SAN、NAS 等，不过使用最多的还是硬盘。

如果从存储数据的介质上来区分，硬盘可分为机械硬盘（Hard Disk Drive, HDD）和固态硬盘（Solid State Disk, SSD），机械硬盘采用磁性碟片来存储数据，而固态硬盘通过闪存颗粒来存储数据。

== 硬盘

=== 机械硬盘(HDD)结构

我们先来看看最常见的机械硬盘。机械硬盘的外观大家可能都见过，那么机械硬盘拆开后是什么样子的呢？如下图所示。

image::images/linux7.jpg[]

机械硬盘主要由磁盘盘片、磁头、主轴与传动轴等组成，数据就存放在磁盘盘片中。大家见过老式的留声机吗？留声机上使用的唱片和我们的磁盘盘片非常相似，只不过留声机只有一个磁头，而硬盘是上下双磁头，盘片在两个磁头中间高速旋转，类似下图。

image::images/linux8.jpg[]

也就是说，机械硬盘是上下盘面同时进数据读取的。而且机械硬盘的旋转速度要远高于唱片（目前机械硬盘的常见转速是 7200 r/min），所以机械硬盘在读取或写入数据时，非常害怕晃动和磕碰。另外，因为机械硬盘的超高转速，如果内部有灰尘，则会造成磁头或盘片的损坏，所以机械硬盘内部是封闭的，如果不是在无尘环境下，则禁止拆开机械硬盘。

==== 机械硬盘的逻辑结构

机械硬盘的逻辑结构主要分为磁道、扇区和拄面。我们来看看 下图。

image::images/linux5.jpg[]

什么是磁道呢？每个盘片都在逻辑上有很多的同心圆，最外面的同心圆就是 0 磁道。我们将每个同心圆称作磁道（注意，磁道只是逻辑结构，在盘面上并没有真正的同心圆）。硬盘的磁道密度非常高，通常一面上就有上千个磁道。但是相邻的磁道之间并不是紧挨着的，这是因为磁化单元相隔太近会相互产生影响。

那扇区又是十么呢？扇区其实是很形象的，大家都见过折叠的纸扇吧，纸扇打开后是半圆形或扇形的，不过这个扇形是由每个扇骨组合形成的。在磁盘上每个同心圆是磁道，从圆心向外呈放射状地产生分割线（扇骨），将每个磁道等分为若干弧段，每个弧段就是一个扇区。每个扇区的大小是固定的，为 512Byte。扇区也是磁盘的最小存储单位。

柱面又是什么呢？如果硬盘是由多个盘片组成的，每个盘面都被划分为数目相等的磁道，那么所有盘片都会从外向内进行磁道编号，最外侧的就是 0 磁道。具有相同编号的磁道会形成一个圆柱，这个圆柱就被称作磁盘的柱面，如下图所示。

image::images/linux6.jpg[]

硬盘的大小是使用"磁头数 x 柱面数 x 扇区数 x 每个扇区的大小"这样的公式来计算的。其中，磁头数（Heads）表示硬盘共有几个磁头，也可以理解为硬盘有几个盘面，然后乘以 2；柱面数（Cylinders）表示硬盘每面盘片有几条磁道；扇区数（Sectors）表示每条磁道上有几个扇区；每个扇区的大小一般是 512Byte。

==== 机械硬盘的接口

机械硬盘通过接口与计算机主板进行连接。硬盘的读取和写入速度与接口有很大关系。大家都见过大礼堂吧，大礼堂中可以容纳很多人，但是如果只有一扇很小的门，那么人是很难进入或出来的，这样会造成拥堵，甚至会出现事故。机械硬盘的读取和写入也是一样的，如果接口的性能很差，则同样会影响机械硬盘的性能。

目前，常见的机械硬盘接口有以下几种：

* IDE 硬盘接口（Integrated Drive Eectronics，并口，即电子集成驱动器）也称作 "ATA硬盘" 或 "PATA硬盘"，是早期机械硬盘的主要接口，ATA133 硬盘的理论速度可以达到 133MB/s（此速度为理论平均值），IDE 硬盘接口如下图 所示。

image::images/linux9.jpg[]
* SATA 接口（Serial ATA，串口），是速度更高的硬盘标准，具备了更高的传输速度，并具备了更强的纠错能力。目前已经是 SATA 三代，理论传输速度达到 600MB/s（此速度为理论平均值），如图所示。

image::images/linux10.jpg[]

* SCSI 接口（Small Computer System Interface，小型计算机系统接口），广泛应用在服务器上，具有应用范围广、多任务、带宽大、CPU 占用率低及热插拔等优点，理论传输速度达到 320MB/s，如图所示。

image::images/linux11.jpg[]

=== 固态硬盘（SSD）

固态硬盘和传统的机械硬盘最大的区别就是不再采用盘片进行数据存储，而采用存储芯片进行数据存储。固态硬盘的存储芯片主要分为两种：一种是采用闪存作为存储介质的；另一种是采用DRAM作为存储介质的。目前使用较多的主要是采用闪存作为存储介质的固态硬盘，如图 8 所示。

image::images/linux12.jpg[]

固态硬盘和机械硬盘对比主要有以下一些特点，如下表所示。

.固态硬盘和机械硬盘对比
|===
|对比项目 |固态硬盘 |机械硬盘

|容量
|较小
|大

|读/写速度
|极快
|—般

|写入次数
|5000〜100000 次
|没有限制

|工作噪声
|极低
|有

|工作温度
|极低
|较高

|防震
|很好
|怕震动

|重量
|低
|高

|价格
|高
|低
|===


大家可以发现，固态硬盘因为丟弃了机械硬盘的物理结构，所以相比机械硬盘具有了低能耗、无噪声、抗震动、低散热、体积小和速度快的优势；不过价格相比机械硬盘更高，而且使用寿命有限。

== 文件系统

=== Linux 文件系统的特性

* super block（超级块）：记录整个文件系统的信息，包括 block 和 inode 的总量，已经使用的 block 和 inode 数量，未使用的 block 和 inode 数量，block 和 inode 的大小，文件系统的挂载时间，最近一次的写入时间，最近一次的磁盘检验时间等。
* data block(数据块，也称为 block)：用来实际保存数据的，block 的大小(1kb,2kb 或 4kb) 和数量在格式化后就已经决定，不能改变，除非重新格式化。每个 block 只能保存一个文件的数据，要是文件数据
小于一个 block 块，那么这个 block 块剩余的空间不能被其他文件的数据使用。要是一个文件的数据大于一个 block 块，则占用多个 block 块。
* inode：用来记录文件的权限(rwx)，文件的所有者和属组，文件的大小，文件的状态改变时间(ctime)，文件的最近一次读取时间(atime)，文件的最近一次修改时间(mtime),文件的数据真正保存的 block 编号。每个文件需要占用一个 inode。

=== 常见的 Linux 文件系统


|===
|文件系统 |描述

| ext
| Linux 中最早的文件系统，由于在性能和兼容性上存在很多缺陷，现在已经很少使用

| ext2
| 是 ext 文件系统的升级版本， Red Hat Linux 7.2 版本之前的系统默认都是 ext2 文件系统。于 1993 年发布，支持最大 16TB 的分区和最大 2TB 的文件

| ext3
| 是 ext2 文件系统的升级版本，最大的区别就是带日志功能。以便系统在突然停止时提高文件系统的可靠性，支持最大 16TB 的分区和最大 2TB 的文件

| ext4
| 是 ext3 文件系统的升级版本，ext4 在性能，伸缩性和可靠性方面进行大量改进。ext4 的变化可以说是翻天覆地的，比如向下兼容 ext3、最大 1EB 文件系统和 16TB 文件、无限制数量子目录、
Extents 连续数据块概念、多块分配、延迟分配、持久预分配、快速 FSCk、日志校验、无日志模式、在线碎片整理、inode 增强、默认启动 barrier 等。它是 CentOS 6.x 的默认文件系统。

| xfs
| XFS 最早针对 IRIX 操作系统开发，是一个高性能的日志文件系统，能够在断点或者操作系统崩溃的情况下保证文件系统数据的一致性，它是一个 64 位的文件系统，后来进行开源并移植到了 Linux 操作系统中，
目前 CentOS 7.x 将 XFS+LVM 作为默认的文件系统。据官方称，XFS 对于大文件的读写性能较好

| swap
| swap 是 Linux 中用于交换分区的文件系统(类似于 Windows 中的虚拟内存)，当内存不够用时，使用交换分区暂时代替内存。一般大小为内存的 2 倍，但是不要超过 2GB。它是 Linux 的必需分区

| NFS
| NFS 是网络文件系统(Network File System)的缩写，是用来实现不同主机之间文件共享的一种网络服务，本地主机可以通过挂载的方式使用远程共享的资源

| iso9660
| 光盘的标准文件系统。Linux 要想使用光盘，必需支撑 iso9660 文件系统

| fat
| 就是 Windows 下的 fat16 文件系统，在 Linux 中识别为 fat

| vfat
| 就是 Windows 下的 fat32 文件系统，在 Linux 中识别为 vfat。支持最大 32GB 的分区和最大 4GB 的文件

| NTFS
| 就是 Windows 下的 NTFS 文件系统，不过 Linux 默认是不能识别 NTFS 文件系统的，如果需要识别，则需要重新编译内核才能支持。它比 fat32 文件系统更加安全，速度更快，支持最大 2TB 的分区和最大 64GB 的文件

| ufs
| Sun 公司的操作系统 Solaris 和 SunOS 所采用的文件系统

| proc
| Linux 中基于内存的虚拟文件系统，用来管理内存存储目录 `/proc`

| sysfs
| 和 proc 一样，也是基于内存的虚拟文件系统，用来管理内存存储目录 `/sysfs`

| tmpfs
| 也是基于内存的虚拟文件系统,不过也可以使用 swap 交换分区
|===

== 常用的硬盘管理命令